# WebLens - Premium Web Intelligence API
# Cloudflare Workers configuration

name = "weblens"
main = "src/index.ts"
compatibility_date = "2025-11-01"
compatibility_flags = ["nodejs_compat"]

# Disable workers.dev subdomain (using custom domain)
workers_dev = false
preview_urls = false

# ============================================
# Custom Domain
# ============================================

[[routes]]
pattern = "api.weblens.dev"
custom_domain = true

# ============================================
# Environment Variables
# ============================================

[vars]
FACILITATOR_URL = "https://x402.org/facilitator"
NETWORK = "base-sepolia"

# ============================================
# KV Namespace for Caching
# Requirement 3.1: Cache responses using Cloudflare KV
# ============================================

# Create KV namespace: wrangler kv:namespace create "CACHE"
# Then add the id below
[[kv_namespaces]]
binding = "CACHE"
id = "4b22a633ea824b80a3ec8003add92d0c"

# ============================================
# KV Namespace for Agent Memory
# Requirement 7.1: Persistent key-value storage for AI agents
# ============================================

# Create KV namespace: wrangler kv:namespace create "MEMORY"
[[kv_namespaces]]
binding = "MEMORY"
id = "822c601a204c45b8bfd4f47dea4805a8"

# ============================================
# KV Namespace for URL Monitors
# Requirement 4.1: URL monitoring with webhook notifications
# ============================================

# Create KV namespace: wrangler kv:namespace create "MONITOR"
[[kv_namespaces]]
binding = "MONITOR"
id = "56bc1fc46c3747978227b19d89d38b41"

# ============================================
# Durable Objects for Monitor Scheduling
# Requirement 4.3: Scheduled URL checking
# ============================================

[[durable_objects.bindings]]
name = "MONITOR_SCHEDULER"
class_name = "MonitorScheduler"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["MonitorScheduler"]

# ============================================
# Browser Rendering
# Requirement 1.1: Screenshot capture using Cloudflare Browser Rendering
# Note: Requires paid Workers plan
# ============================================

[browser]
binding = "BROWSER"

# ============================================
# Secrets (set via wrangler secret put)
# ============================================
# WALLET_ADDRESS - Wallet to receive payments
# ANTHROPIC_API_KEY - For AI-powered extraction (optional)
#
# To switch to mainnet, update NETWORK var above to "base"

# ============================================
# Build Configuration
# ============================================

[build]
command = "npm run build"

# ============================================
# Observability
# ============================================

[observability]
enabled = true
